# Berry Club Bot Workshop

На этом семинаре вы познакомитесь с основами разработки смарт-контрактов на языке Rust для NEAR Protocol.

## Тех-поддержка

* Телеграм РУС: [https://t.me/near_protocol](https://t.me/near_protocol)
* Телеграм ENG: [https://t.me/neardev](https://t.me/neardev)
* Discord [https://near.chat](https://near.chat)
* Документация ENG: [https://docs.near.org/](https://docs.near.org/)

## Подготовка

### Установка

Описанный процесс походит для систем Unix, например Linux или Mac OS. Процесс установки для Windows описан тут [`README_Windows.md`](./README_Windows.md)
 (на английском).

#### Установить [Rustup](https://rustup.rs/):

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source ~/.cargo/env
```

#### Добавить wasm target:

```bash
rustup target add wasm32-unknown-unknown
```

#### Установить `near-cli`

Документация по установке на английском: [`near-cli` installation docs](https://docs.near.org/docs/development/near-cli#installation)

Если `npm` уже установлена, то можно установить `near-cli`:
```bash
npm install -g near-cli
```

#### Установить `git`

Документация по установке на английском: [installation guide](https://github.com/git-guides/install-git) от github.

### Подготовка репозитория и проверка установки

#### Склонируйте репозиторий

```bash
git clone https://github.com/evgenykuzyakov/workshop
cd workshop
```

Это создаст локальную папку `workshop`.

#### Скомпилируйте смарт контракт

```bash
./build.sh
```

Если Rust и `wasm32` были успешно установлены, то `./build.sh` должен скомпилировать контракт в файл `res/berry_bot.wasm`.
```
   Compiling autocfg v1.0.0
   Compiling proc-macro2 v1.0.9
   Compiling unicode-xid v0.2.0
   ...
   Compiling near-vm-logic v2.0.0
   Compiling near-sdk v2.0.0
   Compiling berry-bot v0.1.0 (workshop)
    Finished release [optimized] target(s) in 43.13s
```

#### Проверим, что файл существует `res/berry_bot.wasm`

```bash
test res/berry_bot.wasm && echo "OK" || echo "BAD :("
```

Надеюсь это `OK`

### Настройка аккаунта в NEAR

#### Регистрация нового аккаунта для testnet.

Создайте новый аккаунт используя [NEAR Testnet Wallet](https://wallet.testnet.near.org/)
Web-wallet создаст новый аккаунт на тестовый сети testnet и добавит 200 тестовых NEAR токенов на этот аккаунт.
Запомните свой полный account ID, например `alice.testnet`

В качестве `метода восстановления/Security Method` для этого семинара рекомендуется использовать `Мнемоническую фразу/Recovery Phrase` или `Электронная почта/Email Recovery`.

#### Авторизуйте свой аккаунт в `near-cli`

Чтобы использовать свой аккаунт в `near-cli`, нужно добавить новый ключ в web-wallet:
```bash
near login
```

Это команда откроет новую вкладку в браузере с NEAR Testnet web-wallet и запросит `полный доступ/full access` к вашему аккаунту.
Для этого семинара вам понадобится полный доступ из `near-cli`.

Как только вы разрешите доступ в браузере, командая строка должна успешно завершиться.

Вы должны увидеть что-то подобное в терминале:
```
Logged in as [ alice.testnet ] with public key [ ed25519:HP3oxy... ] successfully
```

#### Сохраните ваше имя использователя в локальную переменную

Для упрощения, сохраните ваше имя использователя в переменную `ACCOUNT_ID` в bash.
Замените `<ИМЯ_ПОЛЬЗОВАТЕЛЯ>` на ваше настоящее имя использователя (account ID который вы создали в web-wallet), например `alice.testnet`.

```bash
export ACCOUNT_ID=<ИМЯ_ПОЛЬЗОВАТЕЛЯ>
```

#### Проверка

Проверим, что вы успешно создали аккаунт и добавили доступ в `near-cli`.

Выполните эту команду:
```bash
near call --accountId=$ACCOUNT_ID workshop.testnet hello
```

Вы должны увидеть что-то подобное:
```
Scheduling a call: workshop.testnet.hello()
Receipt: 5rKUqv4t9JVQryvyfrgrFr8R48iV4sFX7nD56KUv6Vhb
	Log [workshop.testnet]: Hello, test-12331.testnet!
Transaction Id 8D2L4AdhbZ3CqWXMpRURsyqUTNJaBJDcFQsN4W8vU4y7
To see the transaction in the transaction explorer, please open this url in your browser
https://explorer.testnet.near.org/transactions/8D2L4AdhbZ3CqWXMpRURsyqUTNJaBJDcFQsN4W8vU4y7
'Hello, test-12331.testnet!'
```

**Поздравляем!**

## Часть 1 - Баги

Какая неудача! Я сделал пару ошибок пока писал этот смарт контракт, и вам надо их исправить.
Плюс в том, что я добавил тесты, которые работают.

Запустите тесты
```bash
./test.sh
```

Вы должны увидеть нерабочий тест, например:
```
running 1 test
test rect::tests::test_rect_complex ... FAILED

failures:

---- rect::tests::test_rect_complex stdout ----

00 ..................................................
01 ..................................................
02 ..................................................
03 .....XXXX.........................................
04 .....XXXX.........................................
05 .....XXXX.........................................
06 .....XXXX.........................................
07 ..................................................
08 ..................................................
09 ..................................................
10 ..................................................
11 ..................................................
12 ..................................................
13 ..................................................
14 ..................................................
15 ..................................................
16 ..................................................
17 ..................................................
18 ..................................................
19 ..................................................
20 ..................................................
21 ..................................................
22 ..................................................
23 ..................................................
24 ..................................................
25 ..................................................
26 ..................................................
27 ..................................................
28 ..................................................
29 ..................................................
30 ..................................................
31 ..................................................
32 ..................................................
33 ..................................................
34 ..................................................
35 ..................................................
36 ..................................................
37 ..................................................
38 ..................................................
39 ..................................................
40 ..................................................
41 ..................................................
42 ..................................................
43 ..................................................
44 ..................................................
45 ..................................................
46 ..................................................
47 ..................................................
48 ..................................................
49 ..................................................
thread 'rect::tests::test_rect_complex' panicked at 'assertion failed: `(left == right)`
  left: `".....XXXX......"`,
 right: `"..............."`: Line 3', src/rect.rs:90:9
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
```

Это значит `test_rect_complex` не работает. И assert в файле `src/rect.rs` строка `90` неверный.
Откройте этот файл и пропробуйте разобраться, что пошло не так.
После того как вы найдете ошибку и исправите ее, перезапустите тесты.

Повторяйте этот процесс, пока не исправите все ошибки в коде (не в тестах).

Как только все ошибки исправлены, и тесты работают, можно переходить к Часть 2.

## Часть 2 - Порисуем

В этой части вам нужно будет изменить новый метод в смарт контракте, чтобы нарисовать что-то посложнее.
Чтобы это сделать, можно использовать примитивы прямоугольника и окружности, а потом соединить их в одну картинку.

Выполните
```bash
./draw_art.sh
```

Вы должны увидеть текстовое изображение вашего рисунка. Сейчас это мишень с тремя окружностями.

```
00 ..................................................
01 ..................................................
02 ..................................................
03 ..................................................
04 ..................................................
05 .................XXXXXXX..........................
06 ..............XXX.......XXX.......................
07 ............XX.............XX.....................
08 ...........X.................X....................
09 ..........X...................X...................
10 .........X.......XXXXXXX.......X..................
11 ........X......XXX.....XXX......X.................
12 .......X......X...........X......X................
13 .......X.....X.............X.....X................
14 ......X.....X...............X.....X...............
15 ......X....X......XXXXX......X....X...............
16 ......X....X.....XX...XX.....X....X...............
17 .....X....XX....X.......X....XX....X..............
18 .....X....X....XX.......XX....X....X..............
19 .....X....X....X.........X....X....X..............
20 .....X....X....X.........X....X....X..............
21 .....X....X....X.........X....X....X..............
22 .....X....X....XX.......XX....X....X..............
23 .....X....XX....X.......X....XX....X..............
24 ......X....X.....XX...XX.....X....X...............
25 ......X....X......XXXXX......X....X...............
26 ......X.....X...............X.....X...............
27 .......X.....X.............X.....X................
28 .......X......X...........X......X................
29 ........X......XXX.....XXX......X.................
30 .........X.......XXXXXXX.......X..................
31 ..........X...................X...................
32 ...........X.................X....................
33 ............XX.............XX.....................
34 ..............XXX.......XXX.......................
35 .................XXXXXXX..........................
36 ..................................................
37 ..................................................
38 ..................................................
39 ..................................................
40 ..................................................
41 ..................................................
42 ..................................................
43 ..................................................
44 ..................................................
45 ..................................................
46 ..................................................
47 ..................................................
48 ..................................................
49 ..................................................
test art::tests::draw_art ... ok
```

Откройте файл `src/art.rs` и измените метод `internal_render_art` начиная со строки `26`.

Можете нарисовать, что хотите и тестировать это, выполняя `./draw_art.sh`.
Но если вы будете использовать слишком много точек, то это может негативно отразиться на производительности.

Когда вы закончите рисовать в текстовом режиме, то можно будет попробовать это по-настоящему.

## Часть 3 - Запускаем на testnet

### Перекомпилируйте смарт контракт

После того как вы исправили код и добавили ваш рисунок, нужно перекомпилировать смарт контракт.
```bash
./build.sh
```

Каждый раз, когда вы изменяете код контракта, вам нужно будет перекомпилировать контракт.
Результатом служит код файле `res/berry_bot.wasm`

### Добавляем контракт на аккаунт

Аккаунты в NEAR Protocol также могут содержать смарт контракт.
Смарт контракт имеет полный доступ к аккаунту, на котором он расположен.
Но новые транзакции могут быть созданы только пользователями, у которых есть ключ доступа к аккаунту (Это останавливает Skynet и сингулярность).
Транзакция может вызвать метод на смарт контракте и передать параметры.

Чтобы добавить смарт контракт к аккаунту, нужно создать транзакцию.
Я добавил скрипт, который позволяет добавить смарт контракт (или заменить текущий) на ваш аккаунт из переменной `$ACCOUNT_ID`.
(Все что он делает это `near deploy $ACCOUNT_ID res/berry_bot.wasm`)
```bash
./deploy.sh
```

Вы должны увидеть что-то подобное
```
Starting deployment. Account id: test-12331.testnet, node: https://rpc.testnet.near.org, helper: https://helper.testnet.near.org, file: res/berry_bot.wasm
Transaction Id 7jxk9ANig8wJ1BqFennJN4pSuVaMn9n3HjaeKfDYfsDY
To see the transaction in the transaction explorer, please open this url in your browser
https://explorer.testnet.near.org/transactions/7jxk9ANig8wJ1BqFennJN4pSuVaMn9n3HjaeKfDYfsDY
Done deploying to test-12331.testnet
```

Смарт контракт можно изменять много раз.
Каждый раз когда вы изменили код контракта и хотите изменить его на вашем аккаунте, то его нужно перекомпилировать и добавить к аккаунту заного (используя ./deploy.sh).

### Вызов смарт контракта

Чтобы вызвать метод `<МЕТОД>` на вашем смарт контракте с параметрами `<ПАРАМЕТРЫ>`, вызовите следующую команду:
```bash
near call $ACCOUNT_ID --accountId=$ACCOUNT_ID --gas=300000000000000 <МЕТОД> <ПАРАМЕТРЫ>
```

* `<МЕТОД>` - это публичный метод в коде контракта, объявленный с помощью `pub fn`
* `<ПАРАМЕТРЫ>` - это параметры метода, сериализованные с помощью JSON, например `'{"left": 10, "top": 20, "width": 10, "height": 5, "color": 16711680}'`

Так как bash должен получить параметры одной строкой, то рекомендуется оборачивать параметры в `'`, например `'{}'`

Например, чтобы нарисовать ваш рисунок, нужно вызвать следующее:
```bash
near call $ACCOUNT_ID --accountId=$ACCOUNT_ID --gas=300000000000000 render_art '{}'
```

Если все работает как надо, то вы увидете ваш рисунок в логах, например:
```
Scheduling a call: test-12331.testnet.render_art({})
Receipts: B3odJ16wnajwsrUbw2PVZyY2QDCbwFJsTAXvsWTaGGZV, 7FMyKSgszNgGhCBYv7Sg7jVS2b2LzTJ4w8e9T1fTEDWV
	Log [test-12331.testnet]: ..................................................
	Log [test-12331.testnet]: ..................................................
	Log [test-12331.testnet]: ..................................................
	Log [test-12331.testnet]: ..................................................
	Log [test-12331.testnet]: ..................................................
	Log [test-12331.testnet]: .................XXXXXXX..........................
	Log [test-12331.testnet]: ..............XXX.......XXX.......................
	Log [test-12331.testnet]: ............XX.............XX.....................
	Log [test-12331.testnet]: ...........X.................X....................
	Log [test-12331.testnet]: ..........X...................X...................
	Log [test-12331.testnet]: .........X.......XXXXXXX.......X..................
	Log [test-12331.testnet]: ........X......XXX.....XXX......X.................
	Log [test-12331.testnet]: .......X......X...........X......X................
	Log [test-12331.testnet]: .......X.....X.............X.....X................
	Log [test-12331.testnet]: ......X.....X...............X.....X...............
	Log [test-12331.testnet]: ......X....X......XXXXX......X....X...............
	Log [test-12331.testnet]: ......X....X.....XX...XX.....X....X...............
	Log [test-12331.testnet]: .....X....XX....X.......X....XX....X..............
	Log [test-12331.testnet]: .....X....X....XX.......XX....X....X..............
	Log [test-12331.testnet]: .....X....X....X.........X....X....X..............
	Log [test-12331.testnet]: .....X....X....X.........X....X....X..............
	Log [test-12331.testnet]: .....X....X....X.........X....X....X..............
	Log [test-12331.testnet]: .....X....X....XX.......XX....X....X..............
	Log [test-12331.testnet]: .....X....XX....X.......X....XX....X..............
	Log [test-12331.testnet]: ......X....X.....XX...XX.....X....X...............
	Log [test-12331.testnet]: ......X....X......XXXXX......X....X...............
	Log [test-12331.testnet]: ......X.....X...............X.....X...............
	Log [test-12331.testnet]: .......X.....X.............X.....X................
	Log [test-12331.testnet]: .......X......X...........X......X................
	Log [test-12331.testnet]: ........X......XXX.....XXX......X.................
	Log [test-12331.testnet]: .........X.......XXXXXXX.......X..................
	Log [test-12331.testnet]: ..........X...................X...................
	Log [test-12331.testnet]: ...........X.................X....................
	Log [test-12331.testnet]: ............XX.............XX.....................
	Log [test-12331.testnet]: ..............XXX.......XXX.......................
	Log [test-12331.testnet]: .................XXXXXXX..........................
	Log [test-12331.testnet]: ..................................................
	Log [test-12331.testnet]: ..................................................
	Log [test-12331.testnet]: ..................................................
	Log [test-12331.testnet]: ..................................................
	Log [test-12331.testnet]: ..................................................
	Log [test-12331.testnet]: ..................................................
	Log [test-12331.testnet]: ..................................................
	Log [test-12331.testnet]: ..................................................
	Log [test-12331.testnet]: ..................................................
	Log [test-12331.testnet]: ..................................................
	Log [test-12331.testnet]: ..................................................
	Log [test-12331.testnet]: ..................................................
	Log [test-12331.testnet]: ..................................................
	Log [test-12331.testnet]: ..................................................
Transaction Id ZWv4Ac2Qqvs8cA1CT1AHE6ovNXUGT7SCuLiDQFmSqv3
To see the transaction in the transaction explorer, please open this url in your browser
https://explorer.testnet.near.org/transactions/ZWv4Ac2Qqvs8cA1CT1AHE6ovNXUGT7SCuLiDQFmSqv3
''
```

Можно также посмотреть этот рисунок в block explorer, например [Мишень](https://explorer.testnet.near.org/transactions/ZWv4Ac2Qqvs8cA1CT1AHE6ovNXUGT7SCuLiDQFmSqv3)

Чтобы легче вызвать методы я добавил вспомогательный скрипт `./call.sh`.
```bash
./call.sh <МЕТОД> <ПАРАМЕТРЫ>
```

Например, команда, чтобы нарисовать красный прямоугольник:
```bash
./call.sh render_rect '{"left": 10, "top": 20, "width": 10, "height": 5, "color": 16711680}'
```

Или команда, чтобы нарисовать ваш рисунок
```bash
./call.sh render_art '{}'
```

## Часть 4 - Тестируем в продакшене

Если вы увидели ваш рисунок в block explorer, то вы уже оставили свой отпечаток в истории сети NEAR Protocol testnet.
Эти логи теперь сохранены в блокчейне навсегда.

Следующий шаг - нарисовать его в настоящем приложении.

### Скомпилируем в продакшен

На самом деле, сейчас ваш смарт-контракт не вызвает методы в смарт-контракте berry club.
Чтобы это исправить, нужно перекомпилировать его со специальной compilation feature `for_real`:
```bash
./build_for_real.sh
```

Теперь обновите смарт-контракт на вашем аккаунте:
```bash
./deploy.sh
```

Поехали!

### Купите немного 🥑

Первое, что нужно сделать - это прикупить немного авокадо. Авакадо нужно, чтобы рисовать в контракте berry club.
Вызовите вспомогательный метод `buy_avocado` на вашем смарт-контракте:
```bash
./call.sh buy_avocado '{}'
```

Вы должны увидеть следующее:
```
	Log [test-12331.testnet]: Purchased 15001.500 Avocado tokens for 50.000 NEAR
```

`50 NEAR` достаточно чтобы купить `15000` 🥑 и этого хватит чтобы нарисовать `15000` точек.

### Откройте Berry Club на Testnet

[test.berryclub.io](https://test.berryclub.io)

Вы должны увидеть холст 50x50. Он может быть немного "грязный", потому что на нем рисуют все юзеры (одновременно и по очереди).

Оставьте открытой эту вкладку в браузере.

### Нарисуйте ваш рисунок

```bash
./call.sh render_art '{}'
```

Вы должны увидеть его на холсте в браузере, а так же в логах в терминале.
А также ваш аккаунт должен появиться в списке справа от холста.
Если вы наведете курсор на своq аккаунт в списке, то это должно подсветить и ваш рисунок, и ваши точки.

### Конец или нет?

Теперь можете попробовать нарисовать другие примитивы использую `./call.sh`

Или можете изменить ваш рисунок в коде и попробовать нарисовать его заного. 

ВАЖНО! Помните, если вы изменили код, то его нужно перекомпилировать и добавить заново на аккаунт.

Удачи!
